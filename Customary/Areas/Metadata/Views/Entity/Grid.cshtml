@model Custom.Presentation.Sencha.Ext.grid.Panel
@using Custom.Areas.Metadata.Models
@using Custom.Metadata
@using Custom.Presentation
@using Ext = Custom.Presentation.Sencha.Ext
<script type="text/javascript">
    Ext.define('App.metadata.entity.Grid', function () {

        function convertText(text) {
            switch (typeof text) {
                case 'string':
                    return text;

                case 'object':
                    return text.en;

                default:
                    return text;
            }
        };

        var columns = [
            {
                /*editor: {
                    // defaults to textfield if no xtype is supplied
                    allowBlank: true
                },*/
                sortable: false,
                width: 50,
                xtype: "rownumberer",
            },
            {
                editor: {
                    allowBlank: true
                    //vtype: 'email'
                },
                dataIndex: "name",
                fixed: false,
                flex: 1,
                text: "Name",
            },
            {
                editor: {
                    allowBlank: true
                },
                dataIndex: "namespace",
                fixed: false,
                flex: 1,
                text: "Namespace",
            },
            {
                editor: {
                    allowBlank: true
                },
                dataIndex: "titleText",
                fixed: false,
                flex: 1,
                text: "Title",
                //renderer: convertText
            },
            {
                editor: {
                    allowBlank: true
                },
                dataIndex: "summaryText",
                fixed: false,
                flex: 3,
                text: "Summary"
            }
        ];

        var writer = Ext.create('Ext.data.writer.Json', {
            root: 'data',
            allowSingle: false, // force data to be array
            //dateFormat: "",
            writeAllFields: false,
            writeRecordId: true,
            getRecordData: function (record) {
                return {
                    'id': record.data.id,
                    'name': record.data.name,
                    'namespace': record.data.namespace,
                    'title': record.data.title,
                    'summary': record.data.summary,
                    'culture': record.data.culture
                };
            }
        });

        var proxy = {
            // Use for ajax proxy, since all the create, update and detroy requests will be all POST
            // and for jsonp the api is the same, but the method is GET
            type: 'ajax', // rest, jsonp or ajax. 
            api: {
                create: '@Url.Absolute("/Metadata/Entity/Create")',
                read: '@Url.Absolute("/Metadata/Entity/Read")',
                update: '@Url.Absolute("/Metadata/Entity/Update")',
                destroy: '@Url.Absolute("/Metadata/Entity/Destroy")'
            },
            //url: path,
            autoLoad: true,
            headers: {
                "Accept": "application/json"
            },
            listeners: {
                exception: function (proxy, response, operation) {
                    Ext.MessageBox.show({
                        title: 'REMOTE EXCEPTION',
                        msg: operation.getError(),
                        icon: Ext.MessageBox.ERROR,
                        buttons: Ext.Msg.OK
                    });
                }
            },
            reader: {
                type: "json",
                root: "data",
                //dateFormat: "",
                totalProperty: 'total',
                successProperty: 'success',
                messageProperty: 'message'
            },
            writer: {
                type: 'json',
                root: 'data',
                allowSingle: false, // force data to be array
                //dateFormat: "",
                writeAllFields: false,
                writeRecordId: true
            }
        };

        return {
            extend: 'Ext.grid.Panel',
            //alias: 'widget.entityGrid',
            requires: [
                'App.metadata.entity.Model',
                'App.core.Adapter',
                'Ext.form.field.Text',
                'Ext.toolbar.TextItem'
            ],

            columns: {
                items: columns
            },

            /**
             * Called by Ext when instantiating
             * param {Object} config Configuration object
             */
            initComponent: function (config) {

                this.editing = Ext.create('Ext.grid.plugin.RowEditing', {
                    clicksToEdit: 2,
                    clicksToMoveEditor: 1,
                    autoCancel: true
                });
                
                var store = new Ext.data.Store({
                    // destroy the store if the grid is destroyed
                    autoDestroy: true,
                    autoLoad: true,
                    //autoSave: true,
                    autoSync: false,
                    batchActions: true,
                    //buffered: true,
                    model: 'App.metadata.entity.Model',
                    proxy: proxy,
                    pageSize: 100,
                    listeners: {
                        write: function (proxy, operation) {
                            if (operation.action == 'destroy') {
                                //main.child('#form').setActiveRecord(null);
                            }
                            //Ext.example.msg(operation.action, operation.resultSet.message);
                        }
                    },
                    sorters: [{
                        property: 'name',
                        direction: 'ASC'
                    }]
                });

                var dockedItems = [
                    {
                        dock: 'bottom',
                        ui: 'footer',
                        frame: true,
                        xtype: 'toolbar',
                        items: [
                            {
                                iconCls: 'icon-add',
                                text: 'Add',
                                scope: this,
                                handler: this.onAddClick
                            },
                            {
                                iconCls: 'icon-delete',
                                text: 'Delete',
                                disabled: true,
                                itemId: 'delete',
                                scope: this,
                                handler: this.onDeleteClick,
                                disabled: true
                            }, '|',
                            {
                                iconCls: 'icon-sync',
                                text: 'Commit',
                                scope: this,
                                handler: this.onCommitClick
                            },
                            {
                                iconCls: 'icon-sync',
                                text: 'Sync',
                                scope: this,
                                handler: this.onSyncClick
                            },
                            , '->',
                            {
                                scope: this,
                                xtype: 'textfield'
                            },
                            {
                                iconCls: 'icon-search',
                                text: 'Search',
                                scope: this,
                                handler: this.onSearchClick
                            },
                        ]
                    }
                ];

                Ext.apply(this,
                    {
                        iconCls: 'icon-grid',
                        layout: 'fit',
                        dockedItems: dockedItems,
                        plugins: [this.editing],
                        store: store,

                        selModel: Ext.create("Ext.selection.RowModel",
                            {
                                selType: "rowmodel",
                                listeners: {
                                    selectionchange: {
                                        fn: function (selModel, selections) {
                                            this.onSelectionChange(selModel, selections)
                                        },
                                        scope: this
                                    }
                                }
                            })
                    });

                this.callParent();

                //this.getSelectionModel().on('selectionchange', this.onSelectionChange, this);

                App.core.Adapter.publish('App.metadata.entity.Grid.init', this);
            },

            onAddClick: function () {
                App.core.Adapter.publish('App.metadata.entity.Grid.add');
            },

            onDeleteClick: function () {
                App.core.Adapter.publish('App.metadata.entity.Grid.delete');
            },

            onCommitClick: function () {
                App.core.Adapter.publish('App.metadata.entity.Grid.commit');
            },

            onSearchClick: function () {
                App.core.Adapter.publish('App.metadata.entity.Grid.search');
            },

            onSelectionChange: function (selModel, selections) {
                //this.down('#delete').setDisabled(selections.length === 0);
                App.core.Adapter.publish('App.metadata.entity.Grid.selectionchange', selModel, selections);
            },

            onSyncClick: function () {
                App.core.Adapter.publish('App.metadata.entity.Grid.sync');
            }
        };
    });
</script>
